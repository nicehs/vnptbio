### Run it for kubectl
aws eks --region ap-southeast-1 update-kubeconfig --name vnpt-cluster

### Install registry
helm repo add twuni https://twuni.github.io/docker-registry.helm
helm repo update
kubectl create serviceaccount registry-sa --namespace registry
kubectl annotate serviceaccount registry-sa   eks.amazonaws.com/role-arn=arn:aws:iam::387793809941:role/eks-irsa-registry-role   --namespace registry
helm upgrade --install docker-registry twuni/docker-registry   --namespace registry   --create-namespace   --set persistence.enabled=false   --set service.type=ClusterIP   --set service.port=5000  \
 --set storage=s3   --set s3.region=ap-southeast-1   --set s3.bucket=registry-ekyc   --set s3.encrypt=true   --set serviceAccount.create=false   --set serviceAccount.name=registry-sa   --set secrets.s3.secretKey=""

### Install ingress
helm repo add eks https://aws.github.io/eks-charts
helm repo update
kubectl create serviceaccount aws-load-balancer-controller --namespace kube-system
kubectl annotate serviceaccount aws-load-balancer-controller   -n kube-system   esks.amazonaws.com/role-arn=arn:aws:iam::387793809941:role/eks-load-balancer-controller-role
helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller   -n kube-system   --set clusterName=vnpt-cluster   --set serviceAccount.create=false \
  --set region=ap-southeast-1   --set vpcId=vpc-0077f7d4a639c2578   --set serviceAccount.name=aws-load-balancer-controller

helm repo add elastic https://helm.elastic.co
helm repo update
helm install elasticsearch elastic/elasticsearch \
  --namespace logging --create-namespace \
  --set replicas=3 \
  --set volumeClaimTemplate.storageClassName=gp3 \
  --set volumeClaimTemplate.resources.requests.storage=20Gi
eksctl create addon --name aws-ebs-csi-driver --cluster vnpt-cluster --region ap-southeast-1
helm upgrade --install kibana elastic/kibana --namespace logging --set service.type=ClusterIP
eksctl get addon --cluster vnpt-cluster --region ap-southeast-1
aws iam list-attached-role-policies \
  --role-name arn:aws:iam::136079915181:role/eksctl-vnpt-cluster-addon-aws-ebs-csi-dr-Role1-hgTEgPx5FQZq
aws iam attach-role-policy \
  --role-name eksctl-vnpt-cluster-addon-aws-ebs-csi-dr-Role1-hgTEgPx5FQZq \
  --policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy

aws eks update-nodegroup-config \
  --cluster-name vnpt-cluster \
  --nodegroup-name vnpt-node-group3 \
  --scaling-config minSize=1,maxSize=4,desiredSize=2

helm upgrade --install redis bitnami/redis \
  --namespace ekyc-vnpt  \
  --set auth.enabled=false \
  --set tls.enabled=false \
  --set master.persistence.storageClass=gp3 \
  --set master.persistence.size=8Gi

helm upgrade --install kafka ./charts/cp-kafka \
  --namespace ekyc-vnpt \
  --create-namespace \
  --set replicaCount=3 \
  --set persistence.enabled=true \
  --set persistence.storageClass=gp3 \
  --set persistence.size=20Gi \
  --set zookeeper.enabled=true \
  --set zookeeper.url=zookeeper-headless:2181 \
  --set configurationOverrides."listeners"="PLAINTEXT://0.0.0.0:9092\,EXTERNAL://0.0.0.0:9094" \
  --set configurationOverrides."listener\.security\.protocol\.map"="PLAINTEXT:PLAINTEXT\,EXTERNAL:PLAINTEXT" \
  --set configurationOverrides."inter\.broker\.listener\.name"="PLAINTEXT" \
  --set externalAccess.enabled=true \
  --set externalAccess.service.type=NodePort

helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx --create-namespace \
  --set controller.replicaCount=2 \
  --set controller.service.type=NodePort \
  --set controller.service.nodePorts.http=31730 \
  --set controller.service.externalTrafficPolicy=Cluster \
  --set controller.admissionWebhooks.patch.image.registry=localhost:30001 \
  --set controller.admissionWebhooks.patch.image.image=ingress-nginx/kube-webhook-certgen \
  --set controller.admissionWebhooks.patch.image.tag=v1.6.4 \
  --set controller.admissionWebhooks.patch.image.digest="" \
  --set controller.admissionWebhooks.image.digest="" \
  --set controller.admissionWebhooks.image.registry=localhost:30001 \
  --set controller.admissionWebhooks.image.image=ingress-nginx/kube-webhook-certgen \
  --set controller.admissionWebhooks.image.tag=v1.6.4 \
  --set controller.config.allow-server-snippets=true


step: disable aws-cni
step: using cilium as replacement
helm install cilium cilium/cilium \
  --namespace kube-system \
  --set cni.chainingMode=none \
  --set eni.enabled=false \
  --set ipam.mode=cluster-pool \
  --set tunneling=vxlan \
  --set kubeProxyReplacement=true \
  --set ipam.mode=cluster-pool \
  --set ipam.operator.clusterPoolIPv4PodCIDRList="172.16.0.0/16" \
  --set ipam.operator.clusterPoolIPv4MaskSize=24


kubectl patch node <node-name> \
  -p '{"spec":{"podCIDR":"10.244.0.0/24"}}'